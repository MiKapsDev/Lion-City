(function () {
  const mapEl = document.getElementById('couponMap');
  if (!mapEl || !window.L) return;

  const shops = [
    {
      name: 'Staatstheater Braunschweig',
      type: 'Theater',
      address: 'Am Theater, 38100 Braunschweig',
      offer: '5€ Ermäßigter Eintritt',
      coords: [52.266, 10.532382489389382],
    },
    {
      name: 'Städtisches Museum',
      type: 'Museum',
      address: 'Steintorwall 14, 38100 Braunschweig',
      offer: '5€ Ermäßigter Eintritt',
      coords: [52.2613, 10.5320],
    },
    {
      name: 'Wasserwelt Braunschweig',
      type: 'Schwimmbad',
      address: 'Am Schützenpl. 1, 38114 Braunschweig',
      offer: 'Gratis Eintritt Sauna',
      coords: [52.286, 10.5169],
    },
  ];

  const map = L.map(mapEl, {
    scrollWheelZoom: true,
    zoomControl: false,
  }).setView([52.269, 10.526], 12);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
  }).addTo(map);

  const cityBoundary = [
    [52.280561, 10.441263],
    [52.285836, 10.440564],
    [52.287602, 10.426709],
    [52.285013, 10.42605],
    [52.285994, 10.418418],
    [52.287664, 10.419244],
    [52.288018, 10.422409],
    [52.289955, 10.423364],
    [52.29029, 10.426612],
    [52.302671, 10.42375],
    [52.302776, 10.42646],
    [52.304995, 10.426679],
    [52.305965, 10.42398],
    [52.30783, 10.424146],
    [52.308562, 10.422318],
    [52.309931, 10.423959],
    [52.3122, 10.423852],
    [52.318201, 10.412403],
    [52.32165, 10.418528],
    [52.324951, 10.414684],
    [52.325327, 10.416328],
    [52.32763, 10.416861],
    [52.327777, 10.419734],
    [52.330174, 10.424243],
    [52.328072, 10.426442],
    [52.326645, 10.430476],
    [52.325211, 10.431269],
    [52.324496, 10.430153],
    [52.321371, 10.441649],
    [52.324235, 10.445744],
    [52.325907, 10.446468],
    [52.327146, 10.451054],
    [52.330405, 10.447158],
    [52.321942, 10.485093],
    [52.32862, 10.484333],
    [52.330817, 10.492951],
    [52.333572, 10.49287],
    [52.331794, 10.489369],
    [52.333095, 10.484282],
    [52.335783, 10.480849],
    [52.335851, 10.47758],
    [52.340159, 10.476463],
    [52.34551, 10.478994],
    [52.345056, 10.476957],
    [52.350984, 10.475452],
    [52.352227, 10.476776],
    [52.352546, 10.478728],
    [52.350102, 10.480488],
    [52.350436, 10.485195],
    [52.349353, 10.48748],
    [52.349934, 10.489743],
    [52.347933, 10.491846],
    [52.345969, 10.497751],
    [52.348318, 10.497228],
    [52.349962, 10.504054],
    [52.351742, 10.503257],
    [52.35299, 10.506357],
    [52.356308, 10.507514],
    [52.357279, 10.514316],
    [52.356422, 10.515617],
    [52.357574, 10.52078],
    [52.352189, 10.525505],
    [52.349623, 10.530485],
    [52.349434, 10.543545],
    [52.348361, 10.546119],
    [52.34726, 10.54609],
    [52.346919, 10.538832],
    [52.342637, 10.5327],
    [52.342209, 10.528774],
    [52.339739, 10.531155],
    [52.336723, 10.526902],
    [52.330861, 10.527567],
    [52.330424, 10.524879],
    [52.327293, 10.525733],
    [52.32864, 10.532091],
    [52.327904, 10.538243],
    [52.331673, 10.548051],
    [52.332957, 10.546802],
    [52.33579, 10.549268],
    [52.336024, 10.55174],
    [52.339829, 10.553287],
    [52.343309, 10.551653],
    [52.342952, 10.556766],
    [52.343991, 10.558971],
    [52.345043, 10.558422],
    [52.34761, 10.563698],
    [52.347906, 10.567363],
    [52.352008, 10.569073],
    [52.352072, 10.575225],
    [52.350825, 10.575574],
    [52.351928, 10.589932],
    [52.350417, 10.590331],
    [52.349231, 10.594397],
    [52.349631, 10.597197],
    [52.346988, 10.596366],
    [52.345844, 10.597836],
    [52.347507, 10.603294],
    [52.346116, 10.604891],
    [52.345698, 10.607378],
    [52.348567, 10.608452],
    [52.348504, 10.613102],
    [52.346064, 10.612262],
    [52.345652, 10.609934],
    [52.343274, 10.608556],
    [52.342432, 10.600733],
    [52.337112, 10.602026],
    [52.335464, 10.608919],
    [52.339854, 10.620998],
    [52.335205, 10.624976],
    [52.330066, 10.623133],
    [52.328937, 10.628102],
    [52.32618, 10.629028],
    [52.32581, 10.627417],
    [52.322471, 10.628768],
    [52.321717, 10.624786],
    [52.322606, 10.62163],
    [52.320083, 10.622097],
    [52.319612, 10.620348],
    [52.319751, 10.623641],
    [52.319008, 10.623731],
    [52.31799, 10.621469],
    [52.318412, 10.619932],
    [52.314521, 10.618688],
    [52.31162, 10.614053],
    [52.303964, 10.62133],
    [52.302478, 10.630912],
    [52.301549, 10.630637],
    [52.301386, 10.638301],
    [52.302053, 10.639898],
    [52.295504, 10.64318],
    [52.295483, 10.639738],
    [52.297024, 10.635533],
    [52.292629, 10.637532],
    [52.289327, 10.636001],
    [52.289109, 10.638876],
    [52.287145, 10.639019],
    [52.285435, 10.638078],
    [52.285343, 10.634915],
    [52.282752, 10.631458],
    [52.282553, 10.629027],
    [52.281428, 10.628915],
    [52.281361, 10.626716],
    [52.27742, 10.626651],
    [52.277037, 10.613848],
    [52.270289, 10.613043],
    [52.270281, 10.615457],
    [52.268778, 10.615096],
    [52.268635, 10.618635],
    [52.266033, 10.618022],
    [52.265113, 10.620086],
    [52.263778, 10.619986],
    [52.263431, 10.61397],
    [52.264464, 10.614043],
    [52.264674, 10.612458],
    [52.256001, 10.613066],
    [52.25379, 10.608606],
    [52.252902, 10.608874],
    [52.251501, 10.604423],
    [52.250796, 10.59309],
    [52.243623, 10.597506],
    [52.243581, 10.599386],
    [52.24298, 10.59869],
    [52.241504, 10.600259],
    [52.241219, 10.599266],
    [52.239632, 10.600049],
    [52.23412, 10.598571],
    [52.232006, 10.601334],
    [52.226575, 10.600534],
    [52.222748, 10.598298],
    [52.222005, 10.593552],
    [52.22281, 10.592899],
    [52.222948, 10.589417],
    [52.220559, 10.581332],
    [52.223438, 10.576409],
    [52.221126, 10.574044],
    [52.21657, 10.574692],
    [52.215039, 10.571654],
    [52.210723, 10.572342],
    [52.209775, 10.576206],
    [52.206648, 10.575775],
    [52.20477, 10.577621],
    [52.203502, 10.570242],
    [52.202352, 10.570584],
    [52.202838, 10.56256],
    [52.206358, 10.55276],
    [52.202968, 10.550299],
    [52.204487, 10.545749],
    [52.194987, 10.538703],
    [52.191727, 10.538616],
    [52.192476, 10.533371],
    [52.190324, 10.52698],
    [52.19286, 10.525006],
    [52.192077, 10.521698],
    [52.193023, 10.521309],
    [52.192976, 10.518875],
    [52.191653, 10.517358],
    [52.190818, 10.518742],
    [52.190246, 10.515665],
    [52.189569, 10.516131],
    [52.188799, 10.513139],
    [52.187814, 10.513016],
    [52.186784, 10.509919],
    [52.187552, 10.509608],
    [52.186777, 10.505418],
    [52.192051, 10.50112],
    [52.191721, 10.499667],
    [52.194083, 10.498006],
    [52.193483, 10.494924],
    [52.198633, 10.492959],
    [52.199556, 10.491208],
    [52.200633, 10.492004],
    [52.206906, 10.48678],
    [52.202721, 10.476421],
    [52.201589, 10.468608],
    [52.203959, 10.467803],
    [52.203167, 10.439683],
    [52.205336, 10.43843],
    [52.205427, 10.441577],
    [52.206121, 10.441235],
    [52.206029, 10.438023],
    [52.221991, 10.429745],
    [52.225895, 10.433954],
    [52.225793, 10.435977],
    [52.229638, 10.434837],
    [52.229385, 10.433834],
    [52.242821, 10.433278],
    [52.242871, 10.42801],
    [52.245679, 10.428347],
    [52.245382, 10.432845],
    [52.248337, 10.432943],
    [52.24813, 10.434686],
    [52.248794, 10.434696],
    [52.248938, 10.445145],
    [52.252071, 10.445994],
    [52.257581, 10.454365],
    [52.259932, 10.451679],
    [52.257896, 10.446156],
    [52.258075, 10.435044],
    [52.263239, 10.434124],
    [52.262938, 10.430155],
    [52.265506, 10.430516],
    [52.265595, 10.428075],
    [52.267027, 10.42821],
    [52.267267, 10.42138],
    [52.268265, 10.421308],
    [52.269143, 10.421353],
    [52.268939, 10.427242],
    [52.275941, 10.427786],
    [52.276517, 10.438232],
    [52.280443, 10.440729],
    [52.280561, 10.441263],
  ];
  L.polygon(cityBoundary, {
    color: 'rgba(56, 189, 248, 0.65)',
    weight: 2,
    fillOpacity: 0,
  }).addTo(map);
  L.polygon(
    [
      [
        [90, -180],
        [90, 180],
        [-90, 180],
        [-90, -180],
      ],
      cityBoundary,
    ],
    {
      color: 'transparent',
      fillColor: '#0b1220',
      fillOpacity: 0.35,
      interactive: false,
    }
  ).addTo(map);

  const listEl = document.getElementById('couponMapList');
  const markerIcon = L.divIcon({
    className: 'coupon-pin',
    html: '<div class="coupon-pin__dot"></div><div class="coupon-pin__ring"></div>',
    iconSize: [36, 36],
    iconAnchor: [18, 18],
    popupAnchor: [0, -16],
  });
  const markers = shops.map((shop, index) => {
    const marker = L.marker(shop.coords, { icon: markerIcon, shopIndex: index }).addTo(map);
    marker.bindPopup(
      `<strong>${shop.name}</strong><br>${shop.type}<br>${shop.address}<br><span class="map-points">${shop.offer}</span>`
    );

    if (listEl) {
      const item = document.createElement('li');
      item.className = 'map-list-item';
      item.dataset.index = String(index);
      item.innerHTML = `
        <button type="button" class="map-focus" data-index="${index}">
          ${shop.name}
        </button>
        <span class="map-list-meta">${shop.address} · ${shop.offer}</span>
      `;
      listEl.appendChild(item);
    }

    return marker;
  });

  if (listEl) {
    const clearActiveItem = () => {
      listEl.querySelectorAll('.map-list-item').forEach((item) => {
        item.classList.remove('is-active');
      });
    };

    const setActiveItem = (index) => {
      clearActiveItem();
      const targetItem = listEl.querySelector(`.map-list-item[data-index="${index}"]`);
      if (targetItem) {
        targetItem.classList.add('is-active');
      }
    };

    listEl.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const listItem = target.closest('.map-list-item');
      if (!listItem) return;
      const index = Number(listItem.getAttribute('data-index'));
      const marker = markers[index];
      if (!marker) return;
      setActiveItem(index);
      map.flyTo(marker.getLatLng(), 15, { animate: true, duration: 0.8 });
      marker.openPopup();
    });

    map.on('click', clearActiveItem);
    map.on('popupopen', (event) => {
      const source = event.popup?._source;
      const index = source?.options?.shopIndex;
      if (typeof index === 'number') {
        setActiveItem(index);
      }
    });
    map.on('popupclose', clearActiveItem);
  }
})();
